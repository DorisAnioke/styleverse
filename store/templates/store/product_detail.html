{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="product-detail-container">

  <!-- Gallery Section -->
  <div class="gallery-section">
    <!-- Thumbnails -->
    <div class="thumbnails">
      {% if product.images.exists %}
        {% for img in product.images.all %}
          <img src="{{ img.image.url }}" class="thumb" alt="{{ product.name }}" onclick="changeImage({{ forloop.counter0 }})">
        {% endfor %}
      {% else %}
        <img src="{% static 'images/placeholder-product.jpg' %}" class="thumb">
      {% endif %}
    </div>

    <!-- Main Image with navigation -->
    <div class="main-image-container">
      <button class="nav-btn left" onclick="prevImage()">&#10094;</button>
      {% if product.images.first %}
        <img id="mainPreview" src="{{ product.images.first.image.url }}" alt="{{ product.name }}">
      {% else %}
        <img id="mainPreview" src="{% static 'images/placeholder-product.jpg' %}" alt="No Image Available">
      {% endif %}
      <button class="nav-btn right" onclick="nextImage()">&#10095;</button>
    </div>
  </div>

  <!-- Product Info -->
  <div class="product-info">
    <h2>{{ product.name }}</h2>
    <p class="description">{{ product.description }}</p>
    <p class="price">₦{{ product.price|intcomma }}</p>

    {% if reviews.exists %}
      <p class="rating">⭐ {{ avg_rating|floatformat:1 }}/5</p>
    {% endif %}

    <!-- Add to Cart Form -->
    <form method="POST" action="{% url 'store:add_to_cart' product.id %}">
      {% csrf_token %}
      {% if product.size_list.exists %}
        <label for="size">Size:</label>
        <select name="size" id="size" required>
          {% for size in product.size_list %}
            <option value="{{ size.name }}">{{ size.name }}</option>
          {% endfor %}
        </select>
      {% endif %}

      {% if product.color_list.exists %}
        <label for="color">Color:</label>
        <select name="color" id="color" required>
          {% for color in product.color_list %}
            <option value="{{ color.name }}">{{ color.name }}</option>
          {% endfor %}
        </select>
      {% endif %}

      <label for="quantity">Quantity:</label>
      <input type="number" name="quantity" value="1" min="1">
      <button type="submit" class="btn">Add to Cart</button>
      <a href="{% url 'store:cart' %}" class="btn">View Cart</a>
    </form>

    <!-- Wishlist -->
    <form method="POST" action="{% url 'store:add_to_wishlist' product.id %}" style="margin-top:10px;">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline">♡ Add to Wishlist</button>
    </form>

    <button class="btn btn-secondary" onclick="window.history.back()">Go Back</button>

    <!-- Reviews -->
    <div class="reviews">
      <h3>Customer Reviews</h3>
      {% if reviews.exists %}
        {% for review in reviews %}
          <div class="review">
            <strong>{{ review.user.username }}</strong> – ⭐ {{ review.rating }}/5
            <p>{{ review.comment }}</p>
            <small>{{ review.created_at|naturaltime }}</small>
          </div>
        {% endfor %}
      {% else %}
        <p>No reviews yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Slider JS -->
<script>
  const mainImage = document.getElementById("mainPreview");
  const thumbs = document.querySelectorAll(".thumb");
  const images = Array.from(thumbs).map(t => t.src);
  let currentIndex = 0;

  function changeImage(index){
    currentIndex = index;
    mainImage.src = images[currentIndex];
  }

  function prevImage(){
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    mainImage.src = images[currentIndex];
  }

  function nextImage(){
    currentIndex = (currentIndex + 1) % images.length;
    mainImage.src = images[currentIndex];
  }

  // Mobile swipe
  let startX = 0;
  mainImage.addEventListener("touchstart", e => startX = e.changedTouches[0].screenX);
  mainImage.addEventListener("touchend", e => {
    const endX = e.changedTouches[0].screenX;
    if(endX < startX - 50) nextImage();
    else if(endX > startX + 50) prevImage();
  });

  // Keyboard arrows
  document.addEventListener("keydown", e => {
    if(e.key === "ArrowLeft") prevImage();
    else if(e.key === "ArrowRight") nextImage();
  });
</script>

<style>
  .product-detail-container { display:flex; flex-wrap:wrap; gap:20px; margin:20px; }
  .gallery-section { flex:1 1 400px; text-align:center; }
  .main-image-container { position:relative; }
  .main-image-container img { max-width:100%; height:auto; display:block; margin:0 auto; }
  .nav-btn { position:absolute; top:50%; transform:translateY(-50%); background:#fff; border:none; font-size:2rem; cursor:pointer; z-index:2; }
  .nav-btn.left { left:0; }
  .nav-btn.right { right:0; }
  .thumbnails { display:flex; flex-wrap:wrap; justify-content:center; margin-top:10px; gap:5px; }
  .thumb { width:60px; height:60px; object-fit:cover; cursor:pointer; border:2px solid transparent; }
  .thumb:hover, .thumb.active { border-color:#333; }
  .product-info { flex:1 1 400px; }
  @media(max-width:768px){ .product-detail-container{ flex-direction:column; } .thumb{ width:50px; height:50px; } }
</style>
{% endblock %}